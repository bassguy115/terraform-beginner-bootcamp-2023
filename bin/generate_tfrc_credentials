#!/bin/bash

# Check if the TERRAFORM_CLOUD_TOKEN environment variable is set
if [ -z "$TERRAFORM_CLOUD_TOKEN" ]; then
  echo "Error: TERRAFORM_CLOUD_TOKEN environment variable is not set."
  exit 1
fi

# Set the directory path and credentials file path
TERRAFORM_DIR="/home/gitpod/.terraform.d"
CREDENTIALS_FILE="$TERRAFORM_DIR/credentials.tfrc.json"

# Create the .terraform.d directory if it doesn't exist
if [ ! -d "$TERRAFORM_DIR" ]; then
  mkdir -p "$TERRAFORM_DIR"
fi

# Create the credentials file with the provided token
echo '{
  "credentials": {
    "app.terraform.io": {
      "token": "'"$TERRAFORM_CLOUD_TOKEN"'"
    }
  }
}' > "$CREDENTIALS_FILE"

# Check if the credentials file was created successfully
if [ $? -eq 0 ]; then
  echo "Credentials file path: $CREDENTIALS_FILE"
  echo "Credentials file has been generated. You can now use it for Terraform Cloud operations."
else
  echo "Failed to create credentials file."
  exit 1
fi
